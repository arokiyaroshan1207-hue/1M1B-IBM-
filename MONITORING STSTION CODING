/****************************************************
 * IoT-Enabled Weather Monitoring System
 * Board: ESP32
 * Sensors: DHT11/DHT22 (Temperature & Humidity),
 *          Rain Sensor, MQ135 (Air Quality)
 * Cloud: MQTT Broker (ThingSpeak/AWS IoT/Core)
 ****************************************************/

#include <WiFi.h>
#include <PubSubClient.h>
#include "DHT.h"

// -------- WiFi Credentials --------
const char* ssid = "YourWiFiSSID";
const char* password = "YourWiFiPassword";

// -------- MQTT Broker --------
const char* mqtt_server = "test.mosquitto.org";  // Public broker
const int mqtt_port = 1883;
const char* mqtt_topic = "iot/weather_monitoring";

// -------- Sensor Pins --------
#define DHTPIN 4       // GPIO4 for DHT sensor
#define DHTTYPE DHT22  // DHT11 or DHT22
#define RAINPIN 34     // Analog pin for Rain sensor
#define MQ135PIN 35    // Analog pin for Air Quality sensor

// -------- Objects --------
WiFiClient espClient;
PubSubClient client(espClient);
DHT dht(DHTPIN, DHTTYPE);

// -------- Setup --------
void setup() {
  Serial.begin(115200);
  dht.begin();

  // WiFi Connection
  Serial.print("Connecting to WiFi...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi Connected!");

  // MQTT Setup
  client.setServer(mqtt_server, mqtt_port);
  reconnect();
}

// -------- MQTT Reconnect --------
void reconnect() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    if (client.connect("ESP32WeatherNode")) {
      Serial.println("Connected to MQTT broker!");
    } else {
      Serial.print("Failed, rc=");
      Serial.print(client.state());
      Serial.println(" retrying in 5 seconds...");
      delay(5000);
    }
  }
}

// -------- Sensor Reading --------
void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // Read Temperature & Humidity
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  // Read Rain Sensor
  int rainValue = analogRead(RAINPIN);
  float rainfall = map(rainValue, 0, 4095, 0, 100); // % rainfall intensity

  // Read Air Quality (MQ135)
  int airValue = analogRead(MQ135PIN);
  float airQuality = map(airValue, 0, 4095, 0, 500); // AQI approx

  // Print Data
  Serial.println("---- Weather Data ----");
  Serial.print("Temperature: "); Serial.print(temperature); Serial.println(" Â°C");
  Serial.print("Humidity: "); Serial.print(humidity); Serial.println(" %");
  Serial.print("Rainfall: "); Serial.print(rainfall); Serial.println(" %");
  Serial.print("Air Quality Index: "); Serial.print(airQuality); Serial.println(" AQI");

  // Create JSON Payload
  String payload = "{";
  payload += "\"temperature\":"; payload += temperature; payload += ",";
  payload += "\"humidity\":"; payload += humidity; payload += ",";
  payload += "\"rainfall\":"; payload += rainfall; payload += ",";
  payload += "\"air_quality\":"; payload += airQuality;
  payload += "}";

  // Publish to MQTT
  client.publish(mqtt_topic, payload.c_str());
  Serial.println("Data published to MQTT broker!");

  // Delay before next reading
  delay(5000);
}
